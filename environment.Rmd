---
title       : R 軟體套件開發實務應用- 環境設定、語言介紹
subtitle    : 
author      : Wush Wu
job         : 
framework   : io2012-wush
highlighter : highlight.js
hitheme     : zenburn
widgets     : [mathjax]            # {mathjax, quiz, bootstrap}
mode        : selfcontained # {standalone, draft}
knit        : slidify::knit2slides
--- &vcenter .largecontent

```{r setup, include=FALSE, cache=FALSE}
suppressPackageStartupMessages({
  library(knitr)
  library(wordcloud)
  library(RColorBrewer)
})
opts_chunk$set(echo = FALSE, cache = FALSE)
fit100 <- function(fname) sprintf('<img src="assets/img/%s" class="fit100" />', fname)
fit50 <- function(fname) sprintf('<img src="assets/img/%s" class="fit50" />', fname)
fig <- function(fname, size) sprintf('<img src="assets/img/%s" style="max-width:%d%%;max-height:%d%%;" />', fname, size, size)
```

## 目標

- 透過docker快速架設可用的Rstudio Server、http server、各種database
- 解決數種實務上讀取資料的問題
- 版本控制入門(git)

--- &vcenter .largecontent

## 今日環境介紹

- Virtual Box架設的虛擬機器
- 架設細節均在目錄`materials/vagrant`之下
    - Ubuntu 14.04 from [Vagrant](https://www.vagrantup.com/)
    - Docker
    - 虛擬機器的位置應位於`192.168.0.50`
    - 請利用虛擬機器的GUI ，或ssh agent連線到`192.168.0.50`，帳號密碼為`vagrant/vagrant`

--- &vcenter .largecontent

## 啟動Rstudio Server

- 請在命令列輸入：

<pre><code style="font-size:80%">docker run -d --name rstudio -e USER=vagrant -e PASSWORD=vagrant -p 8787:8787 \
    rocker/rstudio
</code></pre>

- 打開Firefox，在網址輸入：`192.168.0.50:8787`
    - 帳號為：`vagrant`
    - 密碼為：`vagrant`

*** =pnotes

講解docker指令
講解`-p`([TCP/UDP端口列表](http://zh.wikipedia.org/wiki/TCP/UDP%E7%AB%AF%E5%8F%A3%E5%88%97%E8%A1%A8))

--- &vcenter .largecontent

## Rstudio 界面解說

- 四塊工作區的功能解說
- 命令列的功能解說與示範
- 展示說明文件
- 展示`example`和`demo`

*** =pnotes

```r
demo(error.catching)
demo(is.things)
demo(recursion)
demo(scoping)
```

--- &vcenter .largecontent

## 建立新專案--建立新套件

- 操作Rstudio Server建立新專案
- 設定Build 選項，切換至套件開發模式

*** =pnotes

解釋三種build選項

--- &vcenter .largecontent

## 動動手

- 請建立一個新專案，名稱為：CRANLog
    - 記得啟用git

<h1 class="big">我們來建立一個抓取資料的套件</h1>

--- &vcenter .largecontent

## 目標簡介

- 資料位置：<http://cran-logs.rstudio.com/>
    - 一個放有<http://cran.rstudio.com/>的線上記錄
- 我們想要抓取每天的套件下載量作分析
- 講師已經預先把12月份的資料至於虛擬機器之中，請執行：

<pre><code style="font-size:80%">docker run -d --name httpd \
  -v /home/vagrant/www:/usr/local/apache2/htdocs -p 80:80 \
  httpd:latest
</code></pre>

*** =pnotes

講解`-v`

--- &vcenter .largecontent #download_script

## 範例下載script =

（修改自<http://cran-logs.rstudio.com/>上的範例）

```r
# 開始日期
start <- as.Date('2015-01-01')
# 結束日期
end <- as.Date('2015-01-02')
# 展開所有日期
all_days <- seq(start, end, by = 'day')
# 扣掉已經下載的連結
missing_days <- setdiff(all_days, tools::file_path_sans_ext(dir(), TRUE))
class(missing_days) <- "Date"
# 拼湊出下載連結
year <- as.POSIXlt(all_days)$year + 1900
urls <- paste0('http://192.168.0.50/cran-log/', year, '/', missing_days, '.csv.gz')
# 可以使用download.file來做下載
for(i in seq_along(urls)) {
  download.file(urls[i], destfile = sprintf("%s.csv.gz", missing_days[i]))
}
```

--- &twocol .largecontent

## R是一個以函數為主體的語言

*** =left

### 看得到的

- `as.Date`
- `seq`
- `setdiff`

*** =right

### 容易忽略的

- `<-`
- `(`
- `for`

*** =pnotes

學習如何檢查特殊字元內容的函數

--- &vcenter .largecontent

## 追程式碼的技巧

- 檢視函數物件
- 檢視S3方法
- 檢視套件中的隱藏物件（介紹`::`和`:::`）

```r
print
methods(print)
print.acf
stats:::print.acf
```

--- &vcenter .largecontent

## 讀取資料

續下載資料的程式

```r
data <- read.table("2015-01-01.csv.gz", header = TRUE, sep = ",")
head(sort(table(data$package), decreasing = TRUE))
```

```
##     digest        DBI       plyr manipulate       Rcpp    ggplot2 
##      1009        973        896        877        867        817 
```

*** =pnotes

- `read.table`
- `sort`
- `table`
- `$`

--- &vcenter .largecontent

## 一個可能的實際情況...

1. 資料來自於某個資料源: `download.file`
1. 每天都要自該資料源更新資料: `missing_days <- ...`
1. 使用既定程序分析出結果: `table`
1. 輸出結果: `print`

--- &vcenter .largecontent

## 把1 ~ 4包成一個函數

```r
pkg_count <- function(date) {
  year <- as.POSIXlt(date)$year + 1900
  urls <- paste0('http://192.168.0.50/cran-log/', year, '/', date, '.csv.gz')
  download.file(urls, destfile = sprintf("%s.csv.gz", date))
  data <- read.table(sprintf("%s.csv.gz", date), header = TRUE, sep = ",")
  sort(table(data$package), decreasing = TRUE)
}
```

--- &vcenter .largecontent

## 可能有什麼問題？

- 缺少文件，不知道date是`Date`物件還是字串（過幾個月後，會忘記的）
- `date`只接受單日
    - 如果錯誤發生，需要追日期怎麼辦？
    
*** =pnotes

`Date`物件介紹

--- &vcenter .largecontent

## 當其他人需要分析結果...

- 將`pkg_count`的程式碼丟給下游（Copy & Paste）
- 將`pkg_count`存成`pkg_count.R`，丟給下游（`source`）
- 將`pkg_count`包成套件，上傳到套件庫供下游下載

--- &vcenter .largecontent

## 將`pkg_count`新增至CRANLog

- 請跟著講師操作

*** =pnotes

建立一個檔案，將上述的`pkg_count`貼上、將檔案儲存至資料夾R 之下、建立和安裝套件、重新啟動、載入`CRANLog`、輸入`pkg_count`

--- &vcenter .largecontent

## 建立`pkg_count`的說明文件

- 請跟著講師操作

--- &vcenter .largecontent

## 將套件放置至私有套件庫

- 請跟著講師操作

*** =pnotes

複習docker的`-v`

--- &vcenter .largecontent

## 嘗試從套件庫中安裝套件CRANLog

- 請跟著講師操作

--- &vcenter .largecontent

## 統一編號查詢

- 很多時候，我們會使用代碼來代表某些資料
- 代碼的意義可能放在某些資料庫之中
- 在製作報表的時候，<font color="red">常常</font>需要將代碼轉譯回人類可讀的文字
    - 重複的程式碼
    - 客製化

--- &vcenter .largecontent

## 啟動mongodb

```sh
docker run -d --name mongo -p 27017:27017 r-mongo
```

--- &vcenter .largecontent

## 使用rmongodb

```{r, eval=FALSE}
library(rmongodb)
mongo <- mongo.create(host = "192.168.0.50")
mongo.get.databases(mongo)
```

--- &vcenter .largecontent

## 安裝套件`rmongodb`

--- &vcenter .largecontent

## 將統編轉換為公司名稱

```{r, eval = FALSE}

```

--- &vcenter .largecontent

## 經驗分享：如何回報bug

<https://github.com/mongosoup/rmongodb/issues/20>

- 清楚的描述環境
    - `sessionInfo()`
- 可重現錯誤的程式碼
- 禮貌、感謝與尊重

--- &vcenter .largecontent

## 政府標案資料

- DSP

--- &vcenter .largecontent

## 啟動PostgreSQL

```sh
docker run -d --name r-postgres -p 5432:5432 r-postgres
```

--- &vcenter .largecontent

## 安裝RPostgreSQL(需要安裝其他相依模組)

--- &vcenter .largecontent

## 利用Docker exec進入container

- 先跑安裝，等待的時候來學Docker

```sh
docker ps
docker exec -it rstudio /bin/bash
apt-get update
apt-get install libpq5-dev # then y
```

--- &vcenter .largecontent

## 是時候講解Docker的原理了

`r fit100("container_vs_vm.jpg")`

--- &twocolvcenter .largecontent

## Container And Image

*** =left

### Docker

- image
- container

*** =right

### 實體機器

- Win7 安裝光碟
- 一台Win7作業系統的電腦

--- &vcenter .largecontent

## 連結資料庫

```{r}
install.packages('RPostgreSQL', repos = 'http://192.168.0.50/R')
library(RPostgreSQL)
db <- dbConnect(dbDriver("PostgreSQL"), host = "192.168.0.50", 
                user = "vagrant", password = "vagrant")

```

--- &vcenter .largecontent

## ETL

--- &vcenter .largecontent

