---
title       : R 軟體套件開發實務應用- 環境設定、語言介紹
subtitle    : 
author      : Wush Wu
job         : 
framework   : io2012-wush
highlighter : highlight.js
hitheme     : zenburn
widgets     : [mathjax]            # {mathjax, quiz, bootstrap}
mode        : selfcontained # {standalone, draft}
knit        : slidify::knit2slides
--- &vcenter .largecontent

```{r setup, include=FALSE, cache=FALSE}
suppressPackageStartupMessages({
  library(knitr)
  library(wordcloud)
  library(RColorBrewer)
})
opts_chunk$set(echo = FALSE, cache = FALSE)
fit100 <- function(fname) sprintf('<img src="assets/img/%s" class="fit100" />', fname)
fit50 <- function(fname) sprintf('<img src="assets/img/%s" class="fit50" />', fname)
fig <- function(fname, size) sprintf('<img src="assets/img/%s" style="max-width:%d%%;max-height:%d%%;" />', fname, size, size)
```

## 學習目標

- Linux 上的命令列環境
- 如何利用docker快速架設可用的Rstudio Server、http server、各種database
- Rstudio Server界面、專案管理、版本控制管理
- 版本控制入門(git)
- 解決數種實務上讀取資料的問題

--- &vcenter .largecontent

## 今日環境介紹

- Virtual Box架設的虛擬機器
    - Ubuntu 14.04 from [Vagrant](https://www.vagrantup.com/)
    - 已經先行架設好Docker以及數個客製化docker images
    - 虛擬機器的位置設定於`192.168.0.50`

--- &vcenter .largecontent

## 命令列

- 虛擬機器的GUI
- 各種ssh client，如: pietty(windows)、openssh(OS X, ubuntu)
- 講者先準備的web-based ssh client，請用瀏覽器打開`https://192.168.0.50:4200`
- Rstudio Server shell（但是需先開啟Rstudio Server）
- 位置：`192.168.0.50`，帳號密碼：`vagrant/vagrant`

--- &vcenter .largecontent

## 啟動Rstudio Server

- 請在命令列輸入：

<pre><code style="font-size:80%">docker run -d --name rstudio -e USER=vagrant -e PASSWORD=vagrant -p 8787:8787 rocker/rstudio</code></pre>

- 在支援的瀏覽器輸入：`192.168.0.50:8787`
    - 帳號為：`vagrant`
    - 密碼為：`vagrant`

*** =pnotes

講解docker指令
講解`-p`([TCP/UDP端口列表](http://zh.wikipedia.org/wiki/TCP/UDP%E7%AB%AF%E5%8F%A3%E5%88%97%E8%A1%A8))

--- &vcenter .largecontent

## Docker 指令詳解：`docker`總覽

```
```

--- &vcenter .largecontent

## Docker 指令詳解：`docker run`總覽

<pre><code style="font-size:80%">docker run -d --name rstudio -e USER=vagrant -e PASSWORD=vagrant -p 8787:8787 rocker/rstudio</code></pre>

```
```

--- &vcenter .largecontent

## Docker 指令詳解：查詢images和指令

- Docker Hub

--- &vcenter .largecontent

## Rstudio 界面解說

- 四塊工作區的功能解說
- 命令列的功能解說與示範
- 展示說明文件
- 展示`example`和`demo`

*** =pnotes

```r
demo(is.things)
demo(error.catching)
demo(scoping)
demo(recursion)
```

--- &vcenter .largecontent

## 說明`建立新專案`(0.98.1091)

- Create Project From
    - New Directory
    - Existed Directory
    - Version Control
- Project Type
    - Empty Project
    - R Packages
    - Shiny Apps

--- &vcenter .largecontent

## 動動手

- 請建立一個一般的新專案，名稱為：CRANLog
    - 記得啟用git

<h1 class="big">我們來建立一個抓取資料的套件</h1>

--- &vcenter .largecontent

## 目標簡介

- 資料位置：<http://cran-logs.rstudio.com/>
    - 一個放有<http://cran.rstudio.com/>的線上記錄
- 我們想要抓取每天的套件下載量作分析
- 講師已經預先把12月份的資料至於虛擬機器之中，請執行：

<pre><code style="font-size:80%">docker run -d --name httpd -v /home/vagrant/www:/usr/local/apache2/htdocs -p 80:80 httpd:latest</code></pre>

*** =pnotes

講解`-v`

--- &vcenter .largecontent #download_script

## 範例下載script =

（修改自<http://cran-logs.rstudio.com/>上的範例）

```r
# 開始日期
start <- as.Date('2015-01-01')
# 結束日期
end <- as.Date('2015-01-02')
# 展開所有日期
all_days <- seq(start, end, by = 'day')
# 扣掉已經下載的連結
missing_days <- setdiff(all_days, tools::file_path_sans_ext(dir(), TRUE))
class(missing_days) <- "Date"
# 拼湊出下載連結
year <- as.POSIXlt(all_days)$year + 1900
urls <- paste0('http://192.168.0.50/cran-log/', year, '/', missing_days, '.csv.gz')
# 可以使用download.file來做下載
for(i in seq_along(urls)) {
  download.file(urls[i], destfile = sprintf("%s.csv.gz", missing_days[i]))
}
```

--- &twocolvcenter .largecontent

## R是一個以函數為主體的語言

*** =left

### 看得到的

- `as.Date`
- `seq`
- `setdiff`

*** =right

### 容易忽略的

- `<-`
- `(`
- `for`

*** =pnotes

學習如何檢查特殊字元內容的函數

--- &vcenter .largecontent

## 追程式碼的技巧

- 檢視函數物件
- 檢視S3方法
- 檢視套件中的隱藏物件（介紹`::`和`:::`）

```r
print
methods(print)
print.acf
stats:::print.acf
```

--- &vcenter .largecontent

## 讀取資料

續下載資料的程式

```r
data <- read.table("2015-01-01.csv.gz", header = TRUE, sep = ",")
head(sort(table(data$package), decreasing = TRUE))
```

```
##     digest        DBI       plyr manipulate       Rcpp    ggplot2 
##      1009        973        896        877        867        817 
```

*** =pnotes

- `read.table`
- `sort`
- `table`
- `$`

--- &vcenter .largecontent

## 一個可能的實際情況...

1. 資料來自於某個資料源: `download.file`
1. 每天都要自該資料源更新資料: `missing_days <- ...`
1. 使用既定程序分析出結果: `table`
1. 輸出結果: `print`

--- &vcenter .largecontent

## 把1 ~ 4包成一個函數

```r
pkg_count <- function(date) {
  year <- as.POSIXlt(date)$year + 1900
  urls <- paste0('http://192.168.0.50/cran-log/', year, '/', date, '.csv.gz')
  download.file(urls, destfile = sprintf("%s.csv.gz", date))
  data <- read.table(sprintf("%s.csv.gz", date), header = TRUE, sep = ",")
  sort(table(data$package), decreasing = TRUE)
}
```

--- &vcenter .largecontent

## 當其他人需要分析結果...

- 將`pkg_count`的程式碼丟給下游（Copy & Paste）
- 將`pkg_count`存成`pkg_count.R`，丟給下游（`source`）
- 將`pkg_count`包成套件，上傳到套件庫供下游下載

--- &vcenter .largecontent

## 利用git 來傳送`pkg_count.R`

- [git](http://git-scm.com/) 提供了許多強大功能
    - 高效能的傳送檔案
    - 版本控制
- [github](https://github.com) 以git 為底的程式碼社交平台
    - 優化程式相關的討論環境
    - 已經和許多線上服務整合
- [gitlab](https://about.gitlab.com/) 私有版本的github

--- &vcenter .largecontent

## 將`pkg_count`新增至CRANLog專案

- 請跟著講師操作，把`pkg_count.R`加入git 的版本控制
    - 會需要設定作者資訊
    - 學習簡單使用rstudio shell

--- &vcenter .largecontent

## 將CRANLog專案上傳到github

- 請跟著講師操作，註冊github帳號
- 設定ssh 金鑰
- 建立專案
- 上傳CRANLog
- 測試下載CRANLog

--- &vcenter .largecontent

## 了解ssh key

- ssh實做了RSA 、DSA 和ECDSA 等非對稱加解密演算法
    - 密碼是兩個檔案：`id_rsa`(private)和`id_rsa.pub`(public)
    - 特色：用public加密的資料，只能用private解密。反之亦然。
    - 廣泛的被運用於各種網頁應用之中，如https。
    - github、AWS 等網站運用這種技術來做自動認證

--- &vcenter .largecontent

## 建立ssh key:`ssh-keygen`

```
Generating public/private rsa key pair.
Enter file in which to save the key (/home/vagrant/.ssh/id_rsa):
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /home/vagrant/.ssh/id_rsa.
Your public key has been saved in /home/vagrant/.ssh/id_rsa.pub.
The key fingerprint is:
dc:fb:51:c6:63:59:13:f1:06:91:d7:1c:dc:36:2f:da vagrant@rtutorial
```

--- &vcenter .largecontent

## 上傳public key

- 請跟著講師操作，上傳key 到github

--- &vcenter .largecontent

## 建立github專案

- 請跟著講師操作

--- &vcenter .largecontent

## 設定遠端專案，上傳

- 請跟著講師操作

圖片出處：[git-tower](http://www.git-tower.com/learn/ebook/command-line/remote-repositories/introduction)

<center>`r fit50("basic-remote-workflow.png")`</center>

--- &vcenter .largecontent

## 下載`pkg_count.R`

- 把自己當成另一個使用者
- 請跟著講師建立新專案CRANLog2
    - 來自版本控制

--- &vcenter .largecontent

## 運用`git`和`github`的好處

- 備份
- 版本控制：
    - 改爛了可以回溯
    - 兩個人一起改就有衝突解決機制
    - 被改爛了可以找到兇手
- 良好的討論空間
- 自動測試
- 自動部署

--- &vcenter .largecontent

## 私人版的github

- [gitlab](https://about.gitlab.com/)

--- &vcenter .largecontent

## 建立`pkg_count`的說明文件

- README.md

```md
這個程式是用來統計R 的套件在CRAN上的下載次數
```

--- .segue .dark

## 套件化

--- &vcenter .largecontent

## 建立套件專案CRANLogPkg

- 請跟著講師操作
    - 建立專案
    - 刪除部分檔案
    - 建立檔案`pkg_count.R`

--- &vcenter .largecontent

## 將套件放置至私有套件庫

- 請跟著講師操作
    - 打包套件
    - 在終端機將套件複製到`~/www/R/src/contrib`
    - 在該目錄下更新套件資訊（`PACKAGES`, `PACKAGES.gz`）（卡住）

*** =pnotes

複習docker的`-v`

--- &vcenter .largecontent

## 利用Docker更新套件資訊

- shell

```sh
docker run -v `pwd`:/src -it --rm rocker/rstudio R
```

- R

```r
setwd("/src")
tools::write_PACKAGES(".")
```

*** =pnotes

工作目錄的概念

--- &vcenter .largecontent

## 直接從套件庫安裝

- 可能需要重新啟動R

```r
install.packages("CRANLogPkg", 
  repos = "http://192.168.0.50/R",
  type = "source")
```

*** =pnotes

原理待日後再細解

--- &vcenter .largecontent

## 統一編號查詢(mongodb)

- 很多時候，我們會使用代碼來代表某些資料
- 代碼的意義可能放在某些資料庫之中
- 在製作報表的時候，<font color="red">常常</font>需要將代碼轉譯回人類可讀的文字
    - 重複的程式碼
    - 客製化

--- &vcenter .largecontent

## 啟動mongodb

```sh
docker run -d --name mongo -p 27017:27017 r-mongo
```

--- &vcenter .largecontent

## 安裝套件`rmongodb`

```r
install.packages("rmongodb")
```

--- &vcenter .largecontent

## 查詢mongodb的必備知識

- `mongo.create`
- `mongo.find`
- cursor related
    - `mongo.cursor.next`
    - `mongo.cursor.value`
- bson related
    - `mongo.bson.to.list`

--- &vcenter .largecontent

## `mongo.create`

```r
?mongo.create
```

--- &vcenter .largecontent

## `mongo.find`和cursor

- Iterator(迭代器)
- 取值
- 有沒有下一個

```
ooo... ==next==> ooo...
^                 ^
```

--- &vcenter .largecontent

## R 中有沒有辦法使用類似迭代器的概念?

- `readLines` + connection
    - 讀一行資料做處理
    - 處理完畢之後再讀下一行資料
    - 讀到沒資料或connection被關閉為止
- 利用bash pipeline `|`來作類似的效果

--- &vcenter .largecontent

## rmongodb的cursor

```
ooo... ==`mongo.cursor.next`==> ooo...
^                                ^
```

--- &vcenter .largecontent

## 將統編轉換為公司名稱

--- &vcenter .largecontent

## 建立套件VATQuery

- 請模仿講者之前的示範，將統編轉換為公司名稱的功能
    - 函數化
    - 放入套件VATInfo
- 更新`DESCRIPTION`
    - 加入`Depends: rmongodb`

--- &vcenter .largecontent

## R 套件和git

- 加入：
    - R/
    - DESCRIPTION
    - NAMESPACE
    
--- &vcenter .largecontent

## DESCRIPTION

- 各欄位解釋
- 新增Depends
- DESCRIPTION和NAMESPACE將在[套件開發](development.html)中再細解

--- &vcenter .largecontent

## 經驗分享：如何回報bug

<https://github.com/mongosoup/rmongodb/issues/20>

- 清楚的描述環境
    - `sessionInfo()`
- 可重現錯誤的程式碼
- 禮貌、感謝與尊重

--- &vcenter .largecontent

## 一般Open Source軟體對於錯誤回報的處理

1. 確認錯誤（看回報的人多不多、開發者能不能重現錯誤）
1. 尋找原因（開發者的事情了...）
1. 徵求貢獻者（開發者有時後會懶的做，拋出來徵求貢獻者）
1. 測試
1. 上patch （除非有重大錯誤，否則每個月只能丟CRAN一次）

--- .dark .segue

## SQL Database

--- &vcenter .largecontent

## 政府標案資料

- 資料來源：[DSP](http://dsp.im)

--- &vcenter .largecontent

## 啟動PostgreSQL

```sh
docker run -d --name r-postgres -p 5432:5432 r-postgres
```

--- &vcenter .largecontent

## 安裝RPostgreSQL(需要安裝其他相依模組)

- 解決方式：
    - google
    - 包好docker，Dockerfile裏面會詳細註明安裝過程

<https://github.com/docker-library/postgres/blob/51e5166d69320581cb707d6fb102d3ba04803400/9.4/Dockerfile>

--- &vcenter .largecontent

## 如何看Dockerfile

- FROM
- RUN
- ENV
- ENTRYPOINT + CMD

--- &vcenter .largecontent

## 利用Docker exec進入container

- 先跑安裝，等待的時候來學Docker

```sh
docker ps
docker exec -it rstudio /bin/bash
apt-get update
apt-get install libpq5-dev # then y
```

--- &vcenter .largecontent

## 是時候講解Docker的原理了

`r fit100("container_vs_vm.jpg")`

--- &twocolvcenter .largecontent

## Container And Image

*** =left

### Docker

- image
- container

*** =right

### 實體機器

- Win7 安裝光碟
- 一台Win7作業系統的電腦

--- &vcenter .largecontent

## 連結資料庫

```{r, eval=FALSE}
install.packages('RPostgreSQL', repos = 'http://192.168.0.50/R')
library(RPostgreSQL)
db <- dbConnect(dbDriver("PostgreSQL"), host = "192.168.0.50", 
                user = "vagrant", password = "vagrant")
dbListTable(db)
```

--- &vcenter .largecontent

## 一次全拿

```r
tenders <- dbReadTable(db, "tenders")
```

--- &vcenter .largecontent

## 自己下SQL Command

```r
tenders <- dbGetQuery(db, "SELECT * FROM tenders LIMIT 100")
```

--- .segue .dark

## 常見問題：中文編碼

--- &vcenter .largecontent

## 編碼知多少

- 位元組(byte)是目前電腦處理記憶體的基本單位。一個位元組有8個位元(bit)。ex: 
    - 00000001, 00111101
- 我們可以用兩個hex code來代表一個位元組。ex: 
    - 00000001 ==> 0000,0001 ==> 0x01
    - 00111101 ==> 0011,1101 ==> 0x3D

--- &vcenter .largecontent

## 編碼知多少

- 文字的"0"和數字的0，在電腦中是不同的！
- R 中整數0L的記憶體，寫成hex code是 00 00 00 00 (佔有四個位元組)
- 數值0.0的記憶體，寫成hex code是 00 00 00 00 00 00 00 00 (佔有八個位元組)
- 文字"0"的記憶體，寫成hex code是 30 (佔有一個位元組)
- 「編碼」就是將位元組合變成人類可讀文字的規則。
    - ASCII: 
        - 0x30 => "0", 0x41 => "A", 0x61 => "a"
        - 0x00 => 空字串(NULL)

--- &vcenter .largecontent

## R 如何處理文字`character`？

- 一段文字，就是一塊連續的「位元組」，直到遇到0x00為止
- 包含0x00的連續位元組，在R 中請使用`RawVector`來處理

--- &vcenter .largecontent

## 萬國碼

- 最初的ASCII 編碼只定義了大部分的英文字母和數字而已
- 各國自行擴充編碼，台灣：big-5
- 世界統一的編碼，UTF
    - UTF-8: 每一個「字」可能是1或2個位元組，中間絕對不會有`NULL`

--- &vcenter .largecontent

## R 的編碼錯誤訊息

```
## Error: 無效的多位元組字串於
## '<bb>O<a5>_<a5><ab><ac>F<a9><b2>ĵ<b9><c1>`<a7><bd>'
```

```
## Error: 
## line 1 appears to contain embedded nulls
```

--- &vcenter .largecontent

## SQL資料庫中解決編碼問題

```r
SET NAMES 'utf-8';
```

--- &vcenter .largecontent

## 將相關功能加入VATInfo

- 請建立一個函數，給定統一編號，查出所有該編號有參與的標案
- 輸出請確定型態是`data.frame`

--- .dark .segue

## R 的資料型態（進階）

--- &vcenter .largecontent

## R 資料的Atomic Type

- 大家都是向量
- 所有東西都是Atomic type所組合而成
    - 常見的資料型態
        - numeric
        - logical
        - integer
        - character

--- &vcenter .largecontent

## R 中組合成高階物件的方式

- list, data.frame
- attributes
- S4

--- &vcenter .largecontent

## list, data.frame

- `iris`

```{r dataframe}
str(iris)
```

--- &vcenter .largecontent

## attributes

- `matrix`, `factor`

```
attributes(iris$Species)
```

--- &vcenter .largecontent

## An example of list + attributes: S3 

```{r s3}
g <- lm(dist ~ speed, cars)
str(head(g))
```

--- &vcenter .largecontent

## S4 

- `dgCMatrix`

```{r}
library(Matrix)
(m <- Matrix(c(0,0,2:0), 3,5))
str(m)
```

--- &vcenter .largecontent

## 輸出的型態

- 在一個弱型態語言中，輸出的型態不定會導致後續使用者的不便
- 型態檢查是必要的：`is.xxx`, xxx為型態名稱
- 檢查TRUE/FALSE時，建議用`isTRUE`

```{r typecheck}
if (NA) print("true") else print("false")
if (isTRUE(NA)) print("true") else print("false")
```

--- &vcenter .largecontent

## 輸出的型態範例：矩陣

```{r matrix}
m <- matrix(1:4, 2, 2)
m[,1]
m[,1,drop=FALSE]
# ?`[`
```